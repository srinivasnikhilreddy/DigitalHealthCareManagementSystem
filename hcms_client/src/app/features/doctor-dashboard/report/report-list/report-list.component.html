<div class="reports-container p-4">

  <h2 class="mb-4">Reports</h2>

  <!-- Generate Report Form -->
  <div class="generate-report-form p-4 mb-4 border rounded shadow-sm bg-white">
    <h3 class="mb-3">Generate New Report</h3>

    <!-- Appointment Select -->
    <mat-form-field appearance="outline" class="w-full mb-3">
      <mat-label>Appointment</mat-label>
      <mat-select [(value)]="selectedAppointment">
        <mat-option *ngFor="let app of appointments" [value]="app">
          {{ app.patientName }} - {{ app.id }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <!-- Report Type Input -->
    <mat-form-field appearance="outline" class="w-full mb-3">
      <mat-label>Report Type</mat-label>
      <input matInput [(ngModel)]="reportType" placeholder="E.g., Prescription, Test Result" />
    </mat-form-field>

    <!-- Report Data Input (same height as input fields) -->
    <mat-form-field appearance="outline" class="w-full mb-3">
      <mat-label>Report Details</mat-label>
      <textarea matInput rows="1" style="height: 56px;" [(ngModel)]="reportData"
                placeholder="Enter report details"></textarea>
    </mat-form-field>

    <!-- Submit Button -->
    <button mat-raised-button color="primary" class="w-full"
            (click)="createReportForSelectedAppointment()"
            [disabled]="!selectedAppointment || !reportType || !reportData">
      Generate Report
    </button>

    <div *ngIf="error" class="text-danger mt-2">{{ error }}</div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="flex justify-center p-4">
    <mat-spinner></mat-spinner>
  </div>

  <!-- Reports Table -->
  <div *ngIf="!loading && dataSource.data.length > 0" class="mat-elevation-z8 bg-white rounded">
    <table mat-table [dataSource]="dataSource" matSort class="w-full">

      <!-- ID Column -->
      <ng-container matColumnDef="id">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>#</th>
        <td mat-cell *matCellDef="let element; let i = index">{{ i + 1 }}</td>
      </ng-container>

      <!-- Patient Name -->
      <ng-container matColumnDef="patientName">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Patient Name</th>
        <td mat-cell *matCellDef="let report">{{ report.patientName }}</td>
      </ng-container>

      <!-- Type -->
      <ng-container matColumnDef="type">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Type</th>
        <td mat-cell *matCellDef="let report">{{ report.type }}</td>
      </ng-container>

      <!-- Report Data -->
      <ng-container matColumnDef="reportData">
        <th mat-header-cell *matHeaderCellDef>Details</th>
        <td mat-cell *matCellDef="let report">{{ report.reportData }}</td>
      </ng-container>

      <!-- Status -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
        <td mat-cell *matCellDef="let report">
          <span [ngStyle]="{
                  'background-color': report.status === 'DELIVERED' ? 'green' :
                                      report.status === 'FAILED' ? 'red' : 'blue',
                  'color': 'white',
                  'padding': '2px 6px',
                  'border-radius': '4px'
                }">
            {{ report.status }}
          </span>
        </td>
      </ng-container>

      <!-- Actions -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Actions</th>
        <td mat-cell *matCellDef="let report">
          <button mat-stroked-button color="primary"
                  (click)="markDelivered(report.id)"
                  [disabled]="report.status === 'DELIVERED'">
            Mark Delivered
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
    </table>

    <mat-paginator [pageSize]="5" [pageSizeOptions]="[5, 10, 20]" showFirstLastButtons></mat-paginator>
  </div>
</div>
